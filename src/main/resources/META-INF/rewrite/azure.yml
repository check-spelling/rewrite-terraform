#
# Copyright 2021 the original author or authors.
# <p>
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# <p>
# https://www.apache.org/licenses/LICENSE-2.0
# <p>
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.AzureBestPractices
displayName: Best practices for Azure
description: Securely operate on Microsoft Azure.
tags:
  - terraform
  - Azure
recipeList:
  - org.openrewrite.terraform.azure.EncryptAzureVMDataDiskWithADECMK
  - org.openrewrite.terraform.azure.EnableAzureStorageSecureTransferRequired
  - org.openrewrite.terraform.azure.DisableKubernetesDashboard
  - org.openrewrite.terraform.azure.EnsureMySQLServerDatabasesHaveEnforceSSLConnectionEnabled
  - org.openrewrite.terraform.azure.EnsureAzurePostgreSQLDatabaseServerWithSSLConnectionIsEnabled
  - org.openrewrite.terraform.azure.SetAzureStorageAccountDefaultNetworkAccessToDeny
  - org.openrewrite.terraform.azure.EnableAzureStorageAccountTrustedMicrosoftServicesAccess
  - org.openrewrite.terraform.azure.EnsureStorageAccountUsesLatestTLSVersion
  - org.openrewrite.terraform.azure.EnsurePublicNetworkAccessEnabledIsSetToFalseForMySQLServers
  - org.openrewrite.terraform.azure.EnsurePostgreSQLServerDisablesPublicNetworkAccess
  - org.openrewrite.terraform.azure.EnsureMySQLServerEnablesGeoRedundantBackups
  - org.openrewrite.terraform.azure.EnableGeoRedundantBackupsOnPostgreSQLServer
  - org.openrewrite.terraform.azure.EnsureAKSPoliciesAddOn
  - org.openrewrite.terraform.azure.EnsurePostgreSQLServerEnablesThreatDetectionPolicy
  - org.openrewrite.terraform.azure.EnsurePostgreSQLServerEnablesInfrastructureEncryption
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EncryptAzureVMDataDiskWithADECMK
displayName: Encrypt Azure VM data disk with ADE/CMK
description: Ensure Azure VM data disk is encrypted with ADE/CMK.
tags:
  - terraform
  - Azure
  - CKV_AZURE_2
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_managed_disk
      content: |-
        encryption_settings {
          enabled = true
        }
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnableAzureStorageSecureTransferRequired
displayName: Enable Azure Storage secure transfer required
description: Microsoft recommends requiring secure transfer for all storage accounts.
tags:
  - terraform
  - Azure
  - CKV_AZURE_3
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_storage_account
      content: 'enable_https_traffic_only = true'
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.DisableKubernetesDashboard
displayName: Disable Kubernetes dashboard
description: Disabling the dashboard eliminates it as an attack vector. The dashboard add-on is disabled by default for all new clusters created on Kubernetes 1.18 or greater.
tags:
  - terraform
  - Azure
  - CKV_AZURE_8
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_kubernetes_cluster
      content: |-
        addon_profile {
          kube_dashboard {
            enabled = false
          }
        }
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsureMySQLServerDatabasesHaveEnforceSSLConnectionEnabled
displayName: Ensure MySQL server databases have Enforce SSL connection enabled
description: Ensure MySQL server databases have Enforce SSL connection enabled.
tags:
  - terraform
  - Azure
  - CKV_AZURE_28
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_mysql_server
      content: ssl_enforcement_enabled = true
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsureAzurePostgreSQLDatabaseServerWithSSLConnectionIsEnabled
displayName: Ensure Azure PostgreSQL database server with SSL connection is enabled
description: Ensure Azure PostgreSQL database server with SSL connection is enabled.
tags:
  - terraform
  - Azure
  - CKV_AZURE_29
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_postgresql_server
      content: ssl_enforcement_enabled = true
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.SetAzureStorageAccountDefaultNetworkAccessToDeny
displayName: Set Azure Storage Account default network access to deny
description: Ensure Azure Storage Account default network access is set to Deny.
tags:
  - terraform
  - Azure
  - CKV_AZURE_35
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_storage_account_network_rules
      content: 'default_action = "Deny"'
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_storage_account
      content: |-
        network_rules {
          default_action = "Deny"
        }
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnableAzureStorageAccountTrustedMicrosoftServicesAccess
displayName: Enable Azure Storage Account Trusted Microsoft Services access
description: Certain Microsoft services that interact with storage accounts operate from networks that cannot be granted access through network rules. Using this configuration, you can allow the set of trusted Microsoft services to bypass those network rules.
tags:
  - terraform
  - Azure
  - CKV_AZURE_36
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_storage_account
      content: 'bypass = ["AzureServices"]'
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_storage_account_network_rules
      content: 'bypass = ["AzureServices"]'
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsureStorageAccountUsesLatestTLSVersion
displayName: Ensure storage account uses latest TLS version
description: Communication between an Azure Storage account and a client application is encrypted using Transport Layer Security (TLS). Microsoft recommends using the latest version of TLS for all your Microsoft Azure App Service web applications.
tags:
  - terraform
  - Azure
  - CKV_AZURE_44
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_storage_account
      content: 'min_tls_version = TLS1_2'
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsurePublicNetworkAccessEnabledIsSetToFalseForMySQLServers
displayName: Ensure public network access enabled is set to False for mySQL servers
description: Ensure public network access enabled is set to False for mySQL servers.
tags:
  - terraform
  - Azure
  - CKV_AZURE_53
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_mysql_server
      content: public_network_access_enabled = false
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsurePostgreSQLServerDisablesPublicNetworkAccess
displayName: Ensure PostgreSQL server disables public network access
description: Ensure PostgreSQL server disables public network access.
tags:
  - terraform
  - Azure
  - CKV_AZURE_68
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_postgresql_server
      content: public_network_access_enabled = false
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsureMySQLServerEnablesGeoRedundantBackups
displayName: Ensure MySQL server enables geo-redundant backups
description: Ensure MySQL server enables geo-redundant backups.
tags:
  - terraform
  - Azure
  - CKV_AZURE_94
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_mysql_server
      content: geo_redundant_backup_enabled = true
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnableGeoRedundantBackupsOnPostgreSQLServer
displayName: Enable geo-redundant backups on PostgreSQL server
description: Ensure PostgreSQL server enables geo-redundant backups.
tags:
  - terraform
  - Azure
  - CKV_AZURE_102
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_postgresql_server
      content: geo_redundant_backup_enabled = true
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsureAKSPoliciesAddOn
displayName: Ensure AKS policies add-on
description: Azure Policy Add-on for Kubernetes service (AKS) extends Gatekeeper v3, an admission controller webhook for Open Policy Agent (OPA), to apply at-scale enforcements and safeguards on your clusters in a centralized, consistent manner.
tags:
  - terraform
  - Azure
  - CKV_AZURE_116
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_kubernetes_cluster
      content: |-
        addon_profile {
          azure_policy {
            enabled = false
          }
        }
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsurePostgreSQLServerEnablesThreatDetectionPolicy
displayName: Ensure PostgreSQL server enables Threat Detection policy
description: Ensure PostgreSQL server enables Threat Detection policy.
tags:
  - terraform
  - Azure
  - CKV_AZURE_128
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_postgresql_server
      content: |-
        threat_detection_policy {
          enabled = true
        }
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.terraform.azure.EnsurePostgreSQLServerEnablesInfrastructureEncryption
displayName: Ensure PostgreSQL server enables infrastructure encryption
description: Ensure PostgreSQL server enables infrastructure encryption.
tags:
  - terraform
  - Azure
  - CKV_AZURE_130
recipeList:
  - org.openrewrite.terraform.AddConfiguration:
      resourceName: azurerm_postgresql_server
      content: infrastructure_encryption_enabled = true
